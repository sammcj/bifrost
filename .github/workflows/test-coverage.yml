name: Run tests and upload coverage

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

jobs:
  test:
    name: Run tests and collect coverage
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Install dependencies
        run: |
          for dir in core framework transports tests/core-providers tests/core-chatbot; do
            if [ -f "$dir/go.mod" ]; then
              echo "Installing dependencies for $dir..."
              (cd "$dir" && go mod download)
            fi
          done

      - name: Run tests
        run: |
          # Run tests for each module and combine coverage
          for dir in core framework transports tests/core-providers tests/core-chatbot; do
            if [ -f "$dir/go.mod" ]; then
              echo "Running tests for $dir..."
              dirname=$(echo $dir | sed 's/\//-/g')
              (cd "$dir" && go test -coverprofile=../coverage-$dirname.txt -coverpkg=github.com/maximhq/bifrost/core/...,github.com/maximhq/bifrost/framework/...,github.com/maximhq/bifrost/transports/... ./... || true)
            fi
          done
          
          # Combine coverage files
          echo "mode: atomic" > coverage.txt
          grep -h -v "^mode:" coverage-*.txt >> coverage.txt 2>/dev/null || true

      - name: Upload results to Codecov
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          slug: maximhq/bifrost

